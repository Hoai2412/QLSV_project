<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chương trình đào tạo | Student Portal</title>

  <!-- ICON + FONT -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- LAYOUT CHUNG -->
  <link rel="stylesheet" href="../css/layout.css" />

  <!-- CSS RIÊNG TRANG CHƯƠNG TRÌNH ĐÀO TẠO -->
  <style>
    body {
      font-family: 'Source Sans 3', sans-serif;
      background: #f6f9fc;
    }

    .page-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-title);
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    /* ===== CONTAINER CHÍNH ===== */
    #curriculum-container {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    /* ===== SEMESTER CARD ===== */
    .semester-block {
      background: #ffffff;
      border: 1px solid var(--border-color);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
      overflow: hidden;
    }

    .semester-header {
      background: #f0f9ff;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .semester-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: #0b3d91;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .semester-title i {
      color: #0ea5e9;
    }

    .semester-credits {
      background: #ffffff;
      border: 1px solid var(--border-color);
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 700;
      color: #0b3d91;
      font-size: 0.9rem;
    }

    /* ===== TABLE TRONG CARD ===== */
    .curriculum-table {
      width: 100%;
      border-collapse: collapse;
    }

    .curriculum-table th {
      background: #ffffff;
      padding: 12px 18px;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #64748b;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    .curriculum-table td {
      padding: 14px 18px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.95rem;
    }

    .curriculum-table tr:hover {
      background: #f8fafc;
    }

    /* ===== BADGE ===== */
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      display: inline-block;
    }

    .badge-required {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge-elective {
      background: #dcfce7;
      color: #15803d;
    }

    /* ===== LOADING ===== */
    .loading {
      padding: 40px;
      text-align: center;
      color: #64748b;
    }
  </style>
</head>

<body>
<div class="app">
  <!-- SIDEBAR -->
  <div id="sidebar"></div>

  <!-- MAIN -->
  <div class="main">
    <!-- HEADER -->
    <div id="header"></div>

    <!-- CONTENT -->
    <main class="content" role="main">
      <div class="container">

        <h2 class="page-title">Chương trình đào tạo</h2>

        <!-- JS SẼ RENDER TOÀN BỘ CTĐT Ở ĐÂY -->
        <div id="curriculum-container">
          <div class="loading">
            <i class="fa-solid fa-spinner fa-spin"></i>
            Đang tải chương trình đào tạo...
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<!-- COMPONENTS -->
<script src="../js/components.js"></script>
<script src="../js/app.js"></script>
<script>
async function loadCurriculum() {
    const container = document.getElementById('curriculum-container');

    try {
        const res = await fetch('/api/student/curriculum', {
            credentials: 'same-origin'
        });

        const result = await res.json();
        console.log(result); // DEBUG

        if (!result.success) {
            container.innerHTML = `<div class="loading">${result.message || 'Không có dữ liệu'}</div>`;
            return;
        }

        if (result.data.length === 0) {
            container.innerHTML = '<div class="loading">Không có môn học</div>';
            return;
        }

        container.innerHTML = '';

        const grouped = {};
        result.data.forEach(item => {
            const key = `Năm ${item.Nam} - HK ${item.HK}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(item);
        });

        Object.entries(grouped).forEach(([semester, courses]) => {
            const totalCredits = courses.reduce((s, c) => s + c.SoTC, 0);

            let rows = '';
            courses.forEach(c => {
                rows += `
                    <tr>
                        <td>${c.MaMH}</td>
                        <td>${c.TenMH}</td>
                        <td>${c.SoTC}</td>
                        <td>
                            <span class="badge ${c.LoaiMon === 'BatBuoc' ? 'badge-required' : 'badge-elective'}">
                                ${c.LoaiMon === 'BatBuoc' ? 'Bắt buộc' : 'Tự chọn'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML += `
                <div class="semester-block">
                    <div class="semester-header">
                        <div class="semester-title">${semester}</div>
                        <div class="semester-credits">${totalCredits} tín chỉ</div>
                    </div>
                    <table class="curriculum-table">
                        <thead>
                            <tr>
                                <th>Mã MH</th>
                                <th>Tên môn</th>
                                <th>TC</th>
                                <th>Loại</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        });

    } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="loading">Lỗi kết nối server</div>';
    }
}

document.addEventListener('DOMContentLoaded', loadCurriculum);
</script>


</body>
</html>
